
Alvec=[0.0452633-0.12302im,-0.460293+0.603819im,0.597399-0.233573im,-0.0293364+0.126848im,-0.0110072-0.248478im,-0.122981+0.545525im,0.229985-0.278961im,0.330354-0.414051im,0.071119+0.0486971im,-0.385127-0.263707im,-0.0367364+0.019565im,0.198937-0.10595im,0.0049569-0.0413253im,-0.0268429+0.223787im,-0.071119-0.0486971im,0.385127+0.263707im,-0.190666-0.528071im,-0.693496+0.460798im,0.751985-0.357478im,0.354656+0.435238im,-0.365833-0.298726im,-0.301372+0.632291im,0.388239-0.582999im,0.444069+0.16085im,-0.0697809+0.00975204im,0.0105488-0.103959im,-0.132663-0.0863465im,0.171147-0.160669im,0.00434457+0.104403im,0.0690771+0.0138867im,-0.146555+0.183378im,0.0966197+0.125379im,1.73472e-18-8.67362e-19im,5.78241e-19+8.67362e-19im,1.73472e-18+8.67362e-19im,1.15648e-18+5.78241e-19im]
Arvec=[-0.0909201+0.0698642im,-0.289241+0.346794im,0.00135463-0.112349im,-0.555384+0.67718im,0.32014-0.36908im,-0.171049+0.369417im,0.366168-0.471846im,0.159302-0.157027im,-0.00959638-0.0065709im,0.0519668+0.0355831im,-0.0857142+0.0409816im,0.464164-0.221925im,0.00721344-0.0947332im,-0.0390626+0.513004im,0.00959638+0.0065709im,-0.0519668-0.0355831im,-0.00241905-0.00392213im,0.00058115-0.0402133im,-0.0202279+0.0347603im,0.00409447-0.00211428im,0.00602025-0.0344545im,0.205853-0.225404im,-0.289941+0.0954815im,0.033898+0.00861883im,-0.0722628+0.0327018im,-0.378628+0.579523im,-0.111347+0.0602274im,-0.537285+0.965388im,0.045758-0.690733im,0.0380939+0.0695713im,-0.00521058-1.10482im,0.0685075+0.106453im,2.60209e-18-4.11997e-18im,0.0+5.78241e-19im,5.85469e-18-1.73472e-18im,4.33681e-19-1.15648e-18im]



include("../src/JTensor.jl")
using JTensor

chi_spin=[0,0,0.5,0.5]
chi=Int(sum(x->2x+1,chi_spin))
inc_spin_no=4
virt_spin=[0.5,0]
D=Int(sum((x->2x+1),virt_spin))
DD=D^2
Aarrows=[1,-1,1,-1]
@show chi_spin
@show inc_spin_no
println()

T=zeros(2,3,3,3,3)
T[1,2,3,3,3]=1
T[2,1,3,3,3]=-1
T[1,3,1,3,3]=-1
T[2,3,2,3,3]=-1
T[1,3,3,1,3]=-1
T[2,3,3,2,3]=-1
T[1,3,3,3,2]=1
T[2,3,3,3,1]=-1

TT=permutedims(reshape(jcontract([T,conj(T)],[[1,-1,-3,-5,-7],[1,-2,-4,-6,-8]]),DD,DD,DD,DD),[1,3,2,4])

MA=spin_singlet_space_from_cg([chi_spin,chi_spin,virt_spin,virt_spin],Aarrows)
MA=reshape(MA,chi,chi,DD,size(MA)[end])
MC=spin_singlet_space_from_cg([chi_spin,chi_spin],[1,-1])

Al=jcontract([MA,Alvec],[[-1,-2,-3,1],[1]])
Ar=jcontract([MA,Arvec],[[-1,-2,-3,1],[1]])

Jc=mapreduce(x->[1-4*mod(x,1) for i=1:2x+1],append!,chi_spin)
Jc=diagm(Jc)

@time Al,Ar,Ac,C,Fl,Fr=sl_mag_trans_vumps(TT,chi,Jc,Al,Ar,e0=1e-10,maxiter=1,ncv=30)
@time A2c=mag_trans_A2c(TT,Fl,Fr,Al,Ac,Jc)

#=
@show jcontract([Al,conj(Al)],[[1,-1,2],[1,-2,2]])
@show jcontract([Ar,conj(Ar)],[[-1,1,2],[-2,1,2]])
A2csvals=svd(reshape(permutedims(A2c,[1,3,2,4]),chi*DD,chi*DD))[2]
@show A2csvals/max(A2csvals...)
flush(STDOUT)
=#

println("inc_chi:")
@time spin_sym_dlmps_inc_chi(Al,Ar,A2c,inc_spin_no,virt_spin,chi_spin,Aarrows)

